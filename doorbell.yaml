blueprint:
  name: Doorbell Automation
  description: >
    # ðŸ”” Doorbell Automation
    **Version: 1.0**

    This blueprint allows you to set up a doorbell automation that can flash lights,

    play sounds, send notifications, and execute custom actions when a doorbell is pressed.

    You can customize the behavior based on whether anyone is home or not.


    [![ko-fi](https://ko-fi.com/img/githubbutton_sm.svg)](https://ko-fi.com/M4M4ZS0Y)
  domain: automation
  source_url: https://raw.githubusercontent.com/Fredrik81/HASS/refs/heads/main/doorbell.yaml
  input:
    trigger_config:
      name: "General Settings"
      icon: mdi:cog
      collapsed: false
      input:
        button_device:
          name: Doorbell Button (MQTT)
          icon: mdi:zigbee
          description: Select the Zigbee2MQTT button to trigger the doorbell.
          selector:
            device:
              filter:
                - integration: mqtt
        zone_entity:
          name: Presence Zone
          icon: mdi:home
          description: Zone entity to check for presence (e.g., zone.home).
          selector:
            entity:
              domain: zone
          default: zone.home
    music_config:
      name: "Music Playback Settings"
      icon: mdi:music
      collapsed: true
      input:
        enable_music:
          name: Enable Music Playback
          icon: mdi:toggle-switch
          description: Enable or disable playing music when the doorbell is triggered.
          default: true
          selector:
            boolean: {}
        media_zone_condition:
          name: When to play media
          icon: mdi:home
          description: Choose when to play media based on zone presence.
          default: always
          selector:
            select:
              options:
                - label: Always
                  value: always
                - label: Only if someone is in the zone
                  value: in
                - label: Only if no one is in the zone
                  value: out
        media_url:
          name: Media File URL
          description: URL of the media file to play (e.g., MP3).
          default: https://raw.githubusercontent.com/Fredrik81/HASS/refs/heads/main/doorbell/doorbell.mp3
          selector:
            text:
              type: url
        media_players:
          name: Media Players
          description: Select media players to play the doorbell sound.
          selector:
            target:
              entity:
                domain: media_player
    notification_config:
      name: "Notification Settings"
      icon: mdi:bell
      collapsed: true
      input:
        enable_notification:
          name: Enable Notifications
          icon: mdi:toggle-switch
          description: Optionally notify a mobile device.
          default: false
          selector:
            boolean: {}
        notify_zone_condition:
          name: When to send notification
          icon: mdi:home
          description: Choose when to send the notification based on zone presence.
          default: always
          selector:
            select:
              options:
                - label: Always
                  value: always
                - label: Only if someone is in the zone
                  value: in
                - label: Only if no one is in the zone
                  value: out
        notify_target:
          name: Notification Target
          icon: mdi:bell
          description: Mobile app notify target (e.g. notify.mobile_app_xyz)
          default: []
          selector:
            device:
              filter:
                - integration: mobile_app
              multiple: true
    custom_actions:
      name: "Custom Actions"
      icon: mdi:script-text
      collapsed: true
      input:
        enable_custom_actions:
          name: Enable Custom Actions
          description: Enable or disable custom actions when the doorbell is triggered.
          default: false
          selector:
            boolean: {}

        custom_actions_presence_condition:
          name: Custom Actions Presence Condition
          description: Choose when to execute custom actions based on zone presence.
          default: always
          selector:
            select:
              options:
                - label: Always
                  value: always
                - label: Only if someone is in the zone
                  value: in
                - label: Only if no one is in the zone
                  value: out
        custom_actions:
          name: Custom Actions
          description: >
            Optional custom actions to execute when the doorbell is pressed.
            This can be a script, scene, or any other service call.
          default: []
          selector:
            action: {}

variables:
  zone: !input zone_entity
  zone_name: "{{ state_attr(zone, 'friendly_name') | lower }}"
  someone_in_zone: >
    {{ expand(states.person) | selectattr('state', 'defined') |
       map(attribute='state') | map('lower') |
       select('equalto', zone_name) | list | count > 0 }}
  media_zone_condition: !input media_zone_condition
  notify_zone_condition: !input notify_zone_condition
  enable_notification: !input enable_notification
  notify_target: !input notify_target
  media_url: !input media_url
  media_players: !input media_players
  enable_music: !input enable_music
  enable_custom_actions: !input enable_custom_actions
  custom_actions_presence_condition: !input custom_actions_presence_condition
  custom_actions: !input custom_actions

triggers:
  - platform: device
    device_id: !input button_device
    domain: mqtt
    type: action
    subtype: single

condition: []

action:
  - service: system_log.write
    data:
      message: >
        media_zone_condition={{ media_zone_condition }},
        someone_in_zone={{ someone_in_zone }},
        enable_notification={{ enable_notification }},
        notify_zone_condition={{ notify_zone_condition }}
      level: warning
  - choose:
    - alias: "Check if media should play"
      conditions:
        - condition: template
          value_template: "{{ enable_music }}"  # Check if music playback is enabled
        - condition: template
          value_template: "{{ media_zone_condition == 'always' or (media_zone_condition == 'in' and someone_in_zone) or (media_zone_condition == 'out' and not someone_in_zone) }}"
      sequence:
        - service: media_player.play_media
          data:
            media_content_id: "{{ media_url }}"
            media_content_type: music
          target: !input media_players

  - choose:
    - alias: "Check if notification should be sent"
      conditions:
        - condition: template
          value_template: "{{ enable_notification }}"  # Check if notification is enabled
        - condition: template
          value_template: "{{ notify_zone_condition == 'always' or (notify_zone_condition == 'in' and someone_in_zone) or (notify_zone_condition == 'out' and not someone_in_zone) }}"
      sequence:
        - service: notify.{{ iif(input.notify_target is string, input.notify_target.split('.')[-1], 'mobile_app') }}
          data:
            title: DÃ¶rrklocka alarm!
            message: "NÃ¥gon Ã¤r vid dÃ¶rren"
  - choose:
      - alias: "Check if custom actions should run"
        conditions:
          - condition: template
            value_template: "{{ enable_custom_actions }}"  # Check if custom actions are enabled
          - condition: template
            value_template: >
              {{ custom_actions_presence_condition == 'always' or
                 (custom_actions_presence_condition == 'in' and someone_in_zone) or
                 (custom_actions_presence_condition == 'out' and not someone_in_zone) }}
        sequence: !input custom_actions  # Execute the custom actions
